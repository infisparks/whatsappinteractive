<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp API GUI</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-bg);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 0 15px;
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control, .btn, #session-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
        }
        .btn:hover { background-color: #0056b3; }

        fieldset {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }

        legend {
            font-weight: bold;
            color: var(--primary-color);
            padding: 0 10px;
        }
        
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-weight: bold;
        }

        .message-area.success { background-color: #d4edda; color: #155724; }
        .message-area.error { background-color: #f8d7da; color: #721c24; }
        .message-area.info { background-color: #d1ecf1; color: #0c5460; }

        .results-area {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            margin-top: 20px;
            border: 1px solid #ced4da;
        }

        #groups-list li:hover { background-color: #f0f0f0; cursor: pointer; }
        .input-highlight { transition: background-color 0.1s ease-in-out; background-color: #d4edda !important; }
        
        #session-select-container { margin-bottom: 20px; }
        .session-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; color: white; margin-left: 10px; }
        .status-open { background-color: var(--success-color); }
        .status-connecting { background-color: var(--warning-color); }
        .status-close { background-color: var(--danger-color); }
        .status-unknown { background-color: var(--secondary-color); }

        #qr-code-container { text-align: center; padding: 20px; }
        #qr-code-container img { max-width: 250px; height: auto; border: 1px solid var(--border-color); padding: 5px; }

        /* General styles for buttons and builders */
        .toggle-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .toggle-btn { flex-grow: 1; background-color: var(--light-bg); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 8px; border-radius: 5px; cursor: pointer; }
        .toggle-btn.active { background-color: var(--primary-color); color: white; }
        .button-section { border-top: 1px dashed var(--border-color); padding-top: 10px; margin-top: 15px; }
        .add-remove-btn { display: inline-block; padding: 5px 10px; margin-left: 10px; background-color: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
        .poll-options-container .poll-option-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .poll-options-container .poll-option-group input { flex-grow: 1; }
        .native-flow-builder { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }
        .native-flow-builder .section-group, .native-flow-builder .row-group { border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .native-flow-builder .section-group legend, .native-flow-builder .row-group legend { font-size: 1em; font-weight: bold; color: var(--secondary-color); }
        .native-flow-builder .row-group { background-color: #f1f5f9; }
        
        /* New button builder styles */
        .interactive-button-group, .product-button-group, .native-flow-button-group {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
        }
        .interactive-button-group .remove-btn, .product-button-group .remove-btn, .native-flow-button-group .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .button-params-container { margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>WhatsApp API GUI</h1>

    <div class="card">
        <h2>Session Management</h2>
        <div class="form-group">
            <label for="session-select">Select Active Session:</label>
            <select id="session-select" class="form-control" required></select>
        </div>
        <div class="form-group">
            <label for="new-session-name">Create New Session:</label>
            <input type="text" id="new-session-name" class="form-control" placeholder="e.g., my-business-account" required>
        </div>
        <button type="button" class="btn" id="create-session-btn" style="background-color: var(--success-color);">Create Session</button>
        <div id="session-management-status" class="message-area"></div>
        <div id="qr-code-container" style="display:none;">
            <h3>Scan QR Code to Link Device</h3>
            <img id="qr-code-image" src="" alt="QR Code">
            <p>Scanning...</p>
        </div>
    </div>

    <div class="card">
        <h2>Interactive Message (Text or Image)</h2>
        <form id="interactive-message-form">
            <div class="form-group">
                <label for="interactive-template-select">Load Template:</label>
                <select id="interactive-template-select" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="interactive-jid">Recipient JID:</label>
                <input type="text" id="interactive-jid" class="form-control jid-input" placeholder="Enter number or click group below" value="@s.whatsapp.net" required>
            </div>
            <div class="form-group">
                <label for="interactive-body">Message Body / Image Caption:</label>
                <textarea id="interactive-body" class="form-control" rows="3" placeholder="This is the main message or caption." required></textarea>
            </div>
            <div class="form-group">
                <label for="interactive-image-url">Image URL (Optional):</label>
                <input type="url" id="interactive-image-url" class="form-control" placeholder="https://example.com/image.png">
            </div>
            <div class="button-section">
                <p>Buttons (Add up to 3)</p>
                <div id="interactive-buttons-container">
                    </div>
                <button type="button" class="btn" id="add-interactive-button" style="background-color: var(--info-color);">Add Button</button>
            </div>
            <button type="submit" class="btn" style="margin-top: 15px;">Send Interactive Message</button>
            <button type="button" class="btn" id="save-interactive-template-btn" style="background-color: #ffc107; color: #212529; margin-top: 15px;">Save as Template</button>
            <div id="interactive-message-status" class="message-area"></div>
        </form>
    </div>

    <div class="card">
        <h2>Product Message with Header</h2>
        <form id="product-message-form">
            <div class="form-group">
                <label for="product-template-select">Load Template:</label>
                <select id="product-template-select" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="product-jid">Recipient JID:</label>
                <input type="text" id="product-jid" class="form-control jid-input" placeholder="Enter number or click group below" value="@s.whatsapp.net" required>
            </div>
            <fieldset>
                <legend>Message Details</legend>
                <div class="form-group"><label for="product-msg-title">Message Title (Header):</label><input type="text" id="product-msg-title" class="form-control" placeholder="Special Offer!" required></div>
                <div class="form-group"><label for="product-msg-caption">Message Caption:</label><textarea id="product-msg-caption" class="form-control" rows="2" placeholder="Check out our latest product." required></textarea></div>
                <div class="form-group"><label for="product-msg-footer">Message Footer:</label><input type="text" id="product-msg-footer" class="form-control" placeholder="Limited time only" required></div>
                <div class="form-group"><label for="product-business-jid">Business Owner JID:</label><input type="text" id="product-business-jid" class="form-control" placeholder="YourBusinessNumber@s.whatsapp.net" required></div>
            </fieldset>
            <fieldset>
                <legend>Product Details</legend>
                <div class="form-group"><label for="product-image-url">Product Image URL:</label><input type="url" id="product-image-url" class="form-control" placeholder="https://example.com/product.jpg" required></div>
                <div class="form-group"><label for="product-title">Product Title:</label><input type="text" id="product-title" class="form-control" placeholder="Awesome Gadget" required></div>
                <div class="form-group"><label for="product-description">Product Description:</label><textarea id="product-description" class="form-control" rows="2" placeholder="The best gadget you can buy." required></textarea></div>
                <div class="form-group"><label for="product-price">Price (e.g., 20000):</label><input type="number" id="product-price" class="form-control" placeholder="20000" required></div>
                <div class="form-group"><label for="product-currency">Currency Code (e.g., IDR, USD):</label><input type="text" id="product-currency" class="form-control" placeholder="IDR" required></div>
                <div class="form-group"><label for="product-retailer-id">Retailer ID (Optional):</label><input type="text" id="product-retailer-id" class="form-control" placeholder="SKU123"></div>
                <div class="form-group"><label for="product-url">Product URL (Optional):</label><input type="url" id="product-url" class="form-control" placeholder="https://example.com/product-page"></div>
            </fieldset>
            <div class="button-section">
                <p>Buttons (Add up to 3)</p>
                <div id="product-buttons-container">
                    </div>
                <button type="button" class="btn" id="add-product-button" style="background-color: var(--info-color);">Add Button</button>
            </div>
            <button type="submit" class="btn" style="margin-top: 15px;">Send Product Message</button>
            <button type="button" class="btn" id="save-product-template-btn" style="background-color: #ffc107; color: #212529; margin-top: 15px;">Save as Template</button>
            <div id="product-message-status" class="message-area"></div>
        </form>
    </div>

    <div class="card">
        <h2>Simple Text Message</h2>
        <form id="text-message-form">
            <div class="form-group">
                <label for="text-template-select">Load Template:</label>
                <select id="text-template-select" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="text-jid">Recipient JID:</label>
                <input type="text" id="text-jid" class="form-control jid-input" placeholder="Enter number or click group below" value="@s.whatsapp.net" required>
            </div>
            <div class="form-group">
                <label for="text-content">Message Text:</label>
                <textarea id="text-content" class="form-control" rows="3" placeholder="Hello, this is a test message!" required></textarea>
            </div>
            <button type="submit" class="btn">Send Text Message</button>
            <button type="button" class="btn" id="save-text-template-btn" style="background-color: #ffc107; color: #212529; margin-top: 15px;">Save as Template</button>
            <div id="text-message-status" class="message-area"></div>
        </form>
    </div>
    
    <div class="card">
        <h2>Send Poll Message</h2>
        <form id="poll-message-form">
            <div class="form-group">
                <label for="poll-template-select">Load Template:</label>
                <select id="poll-template-select" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="poll-jid">Recipient JID:</label>
                <input type="text" id="poll-jid" class="form-control jid-input" placeholder="Enter number or click group below" required>
            </div>
            <div class="form-group">
                <label for="poll-question">Poll Question:</label>
                <input type="text" id="poll-question" class="form-control" placeholder="What is your favorite color?" required>
            </div>
            <div class="form-group">
                <label for="poll-selectable-count">Selectable Options Count (1-100, default is 1):</label>
                <input type="number" id="poll-selectable-count" class="form-control" value="1" min="1" max="100">
            </div>
            <div id="poll-options-container" class="poll-options-container">
                <p>Options (Add at least 2)</p>
                <div class="poll-option-group">
                    <input type="text" class="form-control poll-option" placeholder="Option 1" required>
                    <button type="button" class="add-remove-btn remove-option" style="display: none;">Remove</button>
                </div>
                <div class="poll-option-group">
                    <input type="text" class="form-control poll-option" placeholder="Option 2" required>
                    <button type="button" class="add-remove-btn remove-option" style="display: none;">Remove</button>
                </div>
            </div>
            <button type="button" class="btn" id="add-poll-option" style="background-color: var(--info-color);">Add Option</button>
            <button type="submit" class="btn" style="margin-top: 15px;">Send Poll Message</button>
            <button type="button" class="btn" id="save-poll-template-btn" style="background-color: #ffc107; color: #212529; margin-top: 15px;">Save as Template</button>
            <div id="poll-message-status" class="message-area"></div>
        </form>
    </div>

    <div class="card">
        <h2>Send NativeFlow Message</h2>
        <form id="native-flow-form">
            <div class="form-group">
                <label for="native-flow-jid">Recipient JID:</label>
                <input type="text" id="native-flow-jid" class="form-control jid-input" placeholder="Enter number or click group below" required>
            </div>
            <div class="form-group">
                <label for="native-flow-title">Header Title (Optional):</label>
                <input type="text" id="native-flow-title" class="form-control" placeholder="Igna">
            </div>
            <div class="form-group">
                <label for="native-flow-subtitle">Header Subtitle (Optional):</label>
                <input type="text" id="native-flow-subtitle" class="form-control" placeholder="test">
            </div>
            <div class="form-group">
                <label for="native-flow-body">Body Text:</label>
                <textarea id="native-flow-body" class="form-control" rows="2" placeholder="Fizzxy Dev" required></textarea>
            </div>
            <div class="form-group">
                <label for="native-flow-footer">Footer Text:</label>
                <input type="text" id="native-flow-footer" class="form-control" placeholder="Bot">
            </div>
            
            <div class="button-section">
                <p>Buttons to Include</p>
                <div id="native-flow-buttons-container">
                    </div>
                <button type="button" class="btn" id="add-native-flow-button" style="background-color: var(--info-color);">Add Button</button>
            </div>
            <button type="submit" class="btn" style="margin-top: 15px;">Send NativeFlow Message</button>
            <div id="native-flow-status" class="message-area"></div>
        </form>
    </div>

    <div class="card">
        <h2>Send Bulk Message</h2>
        <form id="bulk-message-form">
            <div class="form-group">
                <label for="bulk-template-select">Select Template:</label>
                <select id="bulk-template-select" class="form-control" required></select>
            </div>
            <div class="form-group">
                <label for="bulk-numbers-textarea">Recipient Numbers (One per line, e.g., 919876543210):</label>
                <textarea id="bulk-numbers-textarea" class="form-control" rows="10" placeholder="Paste numbers here" required></textarea>
            </div>
            <div class="form-group">
                <label for="bulk-delay">Delay between messages (milliseconds):</label>
                <input type="number" id="bulk-delay" class="form-control" value="1000" min="0" required>
            </div>
            <button type="submit" class="btn" style="background-color: var(--success-color);">Start Bulk Send</button>
            <div id="bulk-message-status" class="message-area"></div>
        </form>
    </div>

    <div class="card">
        <h2>Bulk Add to Group</h2>
        <form id="bulk-add-to-group-form">
            <div class="form-group">
                <label for="bulk-group-jid">Group JID:</label>
                <input type="text" id="bulk-group-jid" class="form-control jid-input" placeholder="Click a group from the list above" required>
            </div>
            <div class="form-group">
                <label for="bulk-add-numbers-textarea">User Numbers to Add (One per line):</label>
                <textarea id="bulk-add-numbers-textarea" class="form-control" rows="10" placeholder="Paste numbers here" required></textarea>
            </div>
            <div class="form-group">
                <label for="bulk-add-delay">Delay between additions (milliseconds):</label>
                <input type="number" id="bulk-add-delay" class="form-control" value="2000" min="0" required>
            </div>
            <button type="submit" class="btn" style="background-color: var(--success-color);">Start Bulk Add</button>
            <div id="bulk-add-to-group-status" class="message-area"></div>
        </form>
    </div>

    <div class="card">
        <h2>Bulk Task Status</h2>
        <div id="bulk-status-display" style="display: none;">
            <p>Task Type: <span id="task-type"></span></p>
            <p>Status: <span id="task-status"></span></p>
            <p>Progress: <span id="task-progress"></span></p>
            <progress id="task-progress-bar" value="0" max="100" style="width:100%;"></progress>
            <div id="task-details"></div>
            <button type="button" class="btn" id="cancel-bulk-task-btn" style="background-color: var(--danger-color); margin-top: 10px;">Cancel Task</button>
        </div>
        <div id="no-task-message" class="message-area info">No active bulk task for this session.</div>
    </div>


    <div class="card">
        <h2>Manage Groups</h2>
        <div class="form-group">
            <h3>Fetch All Groups (Group Finder)</h3>
            <form id="get-groups-form">
                <div class="form-group"><label for="group-search">Search Groups:</label><input type="text" id="group-search" class="form-control" placeholder="Type here to search groups by name..."></div>
                <button type="submit" class="btn">Fetch All Groups</button>
                <div id="get-groups-status" class="message-area"></div>
            </form>
            <div id="groups-results" class="results-area" style="display: none;"><ul id="groups-list" style="list-style: none; padding: 0; max-height: 400px; overflow-y: auto;"></ul></div>
        </div>
        <div class="form-group" style="margin-top: 30px;">
            <h3>Fetch a Single Group's Info</h3>
            <form id="get-single-group-form">
                <div class="form-group"><label for="single-group-jid">Group JID:</label><input type="text" id="single-group-jid" class="form-control jid-input" placeholder="Click a group from the list above" required></div>
                <button type="submit" class="btn">Fetch Group Info</button>
                <div id="get-single-group-status" class="message-area"></div>
            </form>
            <div id="single-group-results" class="results-area" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
    let allGroups = [];
    let currentSessionName = null;
    let qrPollingInterval = null;
    let bulkStatusPollingInterval = null;

    async function fetchSessions() {
        try {
            const response = await fetch('/get-sessions');
            const result = await response.json();
            const sessionSelect = document.getElementById('session-select');
            sessionSelect.innerHTML = '';
            
            if (result.success && result.data.length > 0) {
                result.data.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.name;
                    option.textContent = session.name;
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = session.connection;
                    statusSpan.className = `session-status status-${session.connection}`;
                    option.dataset.status = session.connection;
                    sessionSelect.appendChild(option);
                });
                if (!currentSessionName) {
                    currentSessionName = result.data[0].name;
                }
                sessionSelect.value = currentSessionName;
            } else {
                sessionSelect.innerHTML = '<option value="">No sessions found. Create one.</option>';
                currentSessionName = null;
            }
        } catch (error) {
                console.error('Failed to fetch sessions:', error);
        }
    }

    async function handleCreateSession() {
        const sessionName = document.getElementById('new-session-name').value;
        const statusElement = document.getElementById('session-management-status');
        const qrContainer = document.getElementById('qr-code-container');
        const qrImage = document.getElementById('qr-code-image');

        if (!sessionName) {
            statusElement.textContent = 'Please enter a session name.';
            statusElement.style.display = 'block';
            statusElement.className = 'message-area error';
            return;
        }

        try {
            statusElement.textContent = `Creating session '${sessionName}'...`;
            statusElement.style.display = 'block';
            statusElement.className = 'message-area info';
            qrContainer.style.display = 'block';
            qrImage.src = '';
            qrImage.alt = 'Generating QR code...';

            const response = await fetch('/create-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionName })
            });

            const result = await response.json();
            if (result.success) {
                statusElement.textContent = `Session '${sessionName}' created. Now link your device.`;
                statusElement.className = 'message-area success';
                currentSessionName = sessionName;
                pollForQrCode(sessionName);
            } else {
                statusElement.textContent = `Error: ${result.error}`;
                statusElement.className = 'message-area error';
                qrContainer.style.display = 'none';
            }
        } catch (error) {
            statusElement.textContent = `Request failed: ${error.message}`;
            statusElement.className = 'message-area error';
            qrContainer.style.display = 'none';
        }
    }

    function pollForQrCode(sessionName) {
        if (qrPollingInterval) clearInterval(qrPollingInterval);
        const qrContainer = document.getElementById('qr-code-container');
        const qrImage = document.getElementById('qr-code-image');
        const statusElement = document.getElementById('session-management-status');

        qrPollingInterval = setInterval(async () => {
            try {
                const response = await fetch(`/get-qr/${sessionName}`);
                const result = await response.json();
                if (result.success) {
                    if (result.qrImage) {
                        qrImage.src = result.qrImage;
                        qrContainer.querySelector('p').textContent = 'Scan this code with your WhatsApp app.';
                    }
                    if (result.connection === 'open') {
                        clearInterval(qrPollingInterval);
                        statusElement.textContent = `Session '${sessionName}' is now connected!`;
                        statusElement.className = 'message-area success';
                        qrContainer.style.display = 'none';
                        fetchSessions();
                    } else if (result.connection === 'close') {
                        clearInterval(qrPollingInterval);
                        statusElement.textContent = `Session '${sessionName}' disconnected. Please create a new session or check logs.`;
                        statusElement.className = 'message-area error';
                        qrContainer.style.display = 'none';
                        fetchSessions();
                    }
                }
            } catch (error) {
                console.error('QR polling failed:', error);
                clearInterval(qrPollingInterval);
                statusElement.textContent = `QR polling failed. Please check server logs.`;
                statusElement.className = 'message-area error';
                qrContainer.style.display = 'none';
            }
        }, 3000);
    }
    
    async function pollBulkStatus(sessionName) {
        if (bulkStatusPollingInterval) clearInterval(bulkStatusPollingInterval);
        const bulkStatusDisplay = document.getElementById('bulk-status-display');
        const noTaskMessage = document.getElementById('no-task-message');
        const sessionId = sessionName;

        bulkStatusPollingInterval = setInterval(async () => {
            if (!sessionId) {
                bulkStatusDisplay.style.display = 'none';
                noTaskMessage.style.display = 'block';
                return;
            }
            try {
                const response = await fetch(`/get-bulk-status/${sessionId}`);
                const result = await response.json();
                if (result.success) {
                    const task = result.data;
                    bulkStatusDisplay.style.display = 'block';
                    noTaskMessage.style.display = 'none';
                    document.getElementById('task-type').textContent = task.type === 'message' ? 'Bulk Message Send' : 'Bulk Group Add';
                    document.getElementById('task-status').textContent = task.status;
                    document.getElementById('task-progress').textContent = `${task.sentCount + task.failedCount} / ${task.total}`;
                    document.getElementById('task-progress-bar').value = (task.sentCount + task.failedCount) / task.total * 100;
                    
                    let details = `Sent: ${task.sentCount}, Failed: ${task.failedCount}`;
                    if (task.status === 'completed' || task.status === 'cancelled') {
                        details += `\nTask finished.`;
                        document.getElementById('cancel-bulk-task-btn').style.display = 'none';
                        clearInterval(bulkStatusPollingInterval);
                    } else if (task.status === 'running' || task.status === 'paused') {
                         document.getElementById('cancel-bulk-task-btn').style.display = 'block';
                    }
                    if (task.failedTargets.length > 0) {
                        details += `\nFailed numbers: ${task.failedTargets.join(', ')}`;
                    }
                    document.getElementById('task-details').textContent = details;
                } else {
                    bulkStatusDisplay.style.display = 'none';
                    noTaskMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to fetch bulk status:', error);
                bulkStatusDisplay.style.display = 'none';
                noTaskMessage.style.display = 'block';
                clearInterval(bulkStatusPollingInterval);
            }
        }, 5000);
    }

    async function handleFormSubmit(event, endpoint, statusElementId) {
        event.preventDefault();
        const form = event.target;
        const statusElement = document.getElementById(statusElementId);
        const sessionName = document.getElementById('session-select').value;
        if (!sessionName) {
            statusElement.textContent = 'Please select or create a session first.';
            statusElement.style.display = 'block';
            statusElement.className = 'message-area error';
            return;
        }

        statusElement.style.display = 'none';
        statusElement.className = 'message-area';

        let payload = { sessionName };
        let method = 'POST';

        try {
            if (form.id === 'text-message-form') {
                payload.jid = document.getElementById('text-jid').value;
                payload.text = document.getElementById('text-content').value;
                endpoint = '/send-text-message';
            } else if (form.id === 'interactive-message-form') {
                payload.jid = document.getElementById('interactive-jid').value;
                payload.body = document.getElementById('interactive-body').value;
                payload.imageUrl = document.getElementById('interactive-image-url').value;
                payload.buttons = getInteractiveButtons();
                endpoint = '/send-interactive-message';
            } else if (form.id === 'product-message-form') {
                const buttons = getProductButtons();
                payload.jid = document.getElementById('product-jid').value;
                payload.businessOwnerJid = document.getElementById('product-business-jid').value;
                payload.message = {
                    title: document.getElementById('product-msg-title').value,
                    caption: document.getElementById('product-msg-caption').value,
                    footer: document.getElementById('product-msg-footer').value,
                };
                payload.product = {
                    imageUrl: document.getElementById('product-image-url').value,
                    title: document.getElementById('product-title').value,
                    description: document.getElementById('product-description').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    currencyCode: document.getElementById('product-currency').value,
                    retailerId: document.getElementById('product-retailer-id').value,
                    url: document.getElementById('product-url').value
                };
                payload.buttons = buttons;
                endpoint = '/send-product-message';
            } else if (form.id === 'poll-message-form') {
                const options = Array.from(document.querySelectorAll('.poll-option')).map(input => input.value).filter(val => val.trim() !== '');
                if (options.length < 2) {
                    throw new Error('Please provide at least two poll options.');
                }
                payload.jid = document.getElementById('poll-jid').value;
                payload.question = document.getElementById('poll-question').value;
                payload.options = options;
                payload.selectableOptionsCount = parseInt(document.getElementById('poll-selectable-count').value) || 1;
                endpoint = '/send-poll-message';
            } else if (form.id === 'native-flow-form') {
                payload.jid = document.getElementById('native-flow-jid').value;
                payload.title = document.getElementById('native-flow-title').value;
                payload.subtitle = document.getElementById('native-flow-subtitle').value;
                payload.body = document.getElementById('native-flow-body').value;
                payload.footer = document.getElementById('native-flow-footer').value;
                
                const buttons = [];
                document.querySelectorAll('#native-flow-buttons-container .native-flow-button-group').forEach(group => {
                    const buttonType = group.querySelector('.native-flow-button-type').value;
                    let params = {};
                    if (buttonType === 'cta_url') {
                        params.display_text = group.querySelector('.url-display-text').value;
                        params.url = group.querySelector('.url-input').value;
                        params.merchant_url = group.querySelector('.url-input').value;
                    } else if (buttonType === 'cta_reply') {
                        params.display_text = group.querySelector('.reply-display-text').value;
                        params.id = group.querySelector('.reply-id').value;
                    } else if (buttonType === 'cta_call') {
                        params.display_text = group.querySelector('.call-display-text').value;
                    }
                    buttons.push({ name: buttonType, params });
                });
                payload.buttons = buttons;
                endpoint = '/send-native-flow-message';
            } else if (form.id === 'bulk-message-form') {
                const templateName = document.getElementById('bulk-template-select').value;
                if (!templateName) throw new Error('Please select a template.');
                const numbers = document.getElementById('bulk-numbers-textarea').value.split('\n').filter(Boolean);
                if (numbers.length === 0) throw new Error('Please enter at least one number.');

                payload.templateName = templateName;
                payload.numbers = numbers;
                payload.delay = parseInt(document.getElementById('bulk-delay').value);
                endpoint = '/send-bulk-template';
            } else if (form.id === 'bulk-add-to-group-form') {
                 const groupJid = document.getElementById('bulk-group-jid').value;
                 if (!groupJid) throw new Error('Please provide a group JID.');
                 const userNumbers = document.getElementById('bulk-add-numbers-textarea').value.split('\n').filter(Boolean);
                 if (userNumbers.length === 0) throw new Error('Please enter at least one number.');
                 payload.groupJid = groupJid;
                 payload.userNumbers = userNumbers;
                 payload.delay = parseInt(document.getElementById('bulk-add-delay').value);
                 endpoint = '/add-to-group-bulk';
            } else if (form.id === 'get-groups-form') {
                payload = null; method = 'GET'; endpoint = `/get-groups/${sessionName}`;
            } else if (form.id === 'get-single-group-form') {
                const jid = document.getElementById('single-group-jid').value;
                endpoint = `/get-group/${sessionName}/${jid}`;
                payload = null; method = 'GET';
            }

            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (payload) options.body = JSON.stringify(payload);

            const response = await fetch(endpoint, options);
            const result = await response.json();

            statusElement.style.display = 'block';
            if (result.success) {
                statusElement.classList.add('success');
                statusElement.textContent = result.message;
                if (form.id === 'get-groups-form' && result.data) {
                    allGroups = result.data;
                    displayGroups(allGroups);
                } else if (form.id === 'get-single-group-form' && result.data) {
                    displaySingleGroupInfo(result.data);
                }
                if (form.id === 'bulk-message-form' || form.id === 'bulk-add-to-group-form') {
                     pollBulkStatus(sessionName);
                }
            } else {
                statusElement.classList.add('error');
                statusElement.textContent = `Error: ${result.error || 'Unknown error'}`;
            }
        } catch (error) {
            statusElement.style.display = 'block';
            statusElement.classList.add('error');
            statusElement.textContent = `Request Failed: ${error.message}`;
        }
    }
    
    async function handleCancelBulkTask() {
        const sessionName = document.getElementById('session-select').value;
        if (!sessionName) return;
        
        try {
            const response = await fetch('/cancel-bulk-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionName })
            });
            const result = await response.json();
            if (result.success) {
                alert(result.message);
                pollBulkStatus(sessionName);
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert(`Request failed: ${error.message}`);
        }
    }

    function getInteractiveButtons() {
        const buttons = [];
        document.querySelectorAll('#interactive-buttons-container .interactive-button-group').forEach(group => {
            const buttonType = group.querySelector('.interactive-button-type').value;
            const displayText = group.querySelector(`.${buttonType}-display-text`).value;
            let idOrUrl;
            if (buttonType === 'reply') {
                idOrUrl = group.querySelector('.reply-id').value;
                buttons.push({ type: 'reply', displayText, id: idOrUrl });
            } else if (buttonType === 'url') {
                idOrUrl = group.querySelector('.url-input').value;
                buttons.push({ type: 'url', displayText, url: idOrUrl });
            }
        });
        return buttons;
    }
    
    function getProductButtons() {
        const buttons = [];
        document.querySelectorAll('#product-buttons-container .product-button-group').forEach(group => {
            const buttonType = group.querySelector('.product-button-type').value;
            const displayText = group.querySelector(`.${buttonType}-display-text`).value;
            let idOrUrl;
            if (buttonType === 'reply') {
                idOrUrl = group.querySelector('.reply-id').value;
                buttons.push({ type: 'reply', displayText, id: idOrUrl });
            } else if (buttonType === 'url') {
                idOrUrl = group.querySelector('.url-input').value;
                buttons.push({ type: 'url', displayText, url: idOrUrl });
            }
        });
        return buttons;
    }

    function displayGroups(groups) {
        const groupsList = document.getElementById('groups-list');
        groupsList.innerHTML = '';
        document.getElementById('groups-results').style.display = 'block';
        if (groups.length === 0) {
            groupsList.innerHTML = '<li>No groups found.</li>';
            return;
        }
        groups.forEach(group => {
            const li = document.createElement('li');
            li.dataset.jid = group.id;
            li.innerHTML = `<div class="group-info"><span style="font-weight: bold;">${group.name || 'No Name'}</span><br><small style="color: var(--secondary-color);">${group.id}</small></div>`;
            li.addEventListener('click', (event) => {
                const clickedJid = event.currentTarget.dataset.jid;
                document.querySelectorAll('.jid-input').forEach(input => {
                    input.value = clickedJid;
                    input.classList.add('input-highlight');
                    setTimeout(() => input.classList.remove('input-highlight'), 1000);
                });
            });
            groupsList.appendChild(li);
        });
    }

    function displaySingleGroupInfo(data) {
        const resultsDiv = document.getElementById('single-group-results');
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'block';

        if (data.participants && data.participants.length > 0) {
            const participantNumbers = data.participants.map(p => p.id.split('@')[0]);
            const participantListString = participantNumbers.join('\n');

            const participantsHeader = document.createElement('h4');
            participantsHeader.textContent = "Participants (Ready to Copy for 'Add Users')";
            participantsHeader.style.cssText = 'margin-top: 0; font-family: -apple-system, sans-serif; white-space: normal;';

            const participantsTextarea = document.createElement('textarea');
            participantsTextarea.className = 'form-control';
            participantsTextarea.rows = 8;
            participantsTextarea.readOnly = true;
            participantsTextarea.value = participantListString;

            const instruction = document.createElement('small');
            instruction.textContent = 'Click inside and press Ctrl+A, then Ctrl+C to copy all numbers.';
            instruction.style.cssText = 'display: block; margin-top: 5px; font-family: -apple-system, sans-serif; white-space: normal;';

            resultsDiv.appendChild(participantsHeader);
            resultsDiv.appendChild(participantsTextarea);
            resultsDiv.appendChild(instruction);
        }

        const rawDataHeader = document.createElement('h4');
        rawDataHeader.textContent = "Raw Group Data";
        rawDataHeader.style.cssText = 'margin-top: 20px; font-family: -apple-system, sans-serif; white-space: normal;';

        const rawDataPre = document.createElement('pre');
        rawDataPre.textContent = JSON.stringify(data, null, 2);

        resultsDiv.appendChild(rawDataHeader);
        resultsDiv.appendChild(rawDataPre);
    }

    function addInteractiveButton() {
        const container = document.getElementById('interactive-buttons-container');
        const buttonCount = container.querySelectorAll('.interactive-button-group').length;
        if (buttonCount >= 3) {
            alert('You can only add up to 3 buttons.');
            return;
        }
        const newGroup = document.createElement('div');
        newGroup.className = 'form-group interactive-button-group';
        newGroup.innerHTML = `
            <label>Button ${buttonCount + 1}:</label>
            <button type="button" class="add-remove-btn remove-btn" onclick="removeInteractiveButton(this)">Remove</button>
            <div class="form-group">
                <label>Button Type:</label>
                <select class="form-control interactive-button-type" onchange="updateInteractiveButtonFields(this)">
                    <option value="reply">Quick Reply</option>
                    <option value="url">URL</option>
                </select>
            </div>
            <div class="button-params-container reply-params">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control reply-display-text" name="interactive_button_${buttonCount + 1}_text" placeholder="e.g., 'Get Info'" required>
                </div>
                <div class="form-group">
                    <label>Button ID:</label>
                    <input type="text" class="form-control reply-id" name="interactive_button_${buttonCount + 1}_id" placeholder="e.g., 'info_123'" required>
                </div>
            </div>
            <div class="button-params-container url-params" style="display:none;">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control url-display-text" name="interactive_button_${buttonCount + 1}_text_url" placeholder="e.g., 'Visit Website'" required>
                </div>
                <div class="form-group">
                    <label>URL:</label>
                    <input type="url" class="form-control url-input" name="interactive_button_${buttonCount + 1}_url_link" placeholder="https://example.com" required>
                </div>
            </div>
        `;
        container.appendChild(newGroup);
    }
    
    function removeInteractiveButton(btn) {
        btn.closest('.interactive-button-group').remove();
    }
    
    function updateInteractiveButtonFields(select) {
        const container = select.closest('.interactive-button-group');
        const type = select.value;
        container.querySelectorAll('.button-params-container').forEach(el => {
            el.style.display = 'none';
            el.querySelectorAll('input').forEach(input => input.required = false);
        });
        const paramsContainer = container.querySelector(`.${type}-params`);
        if (paramsContainer) {
             paramsContainer.style.display = 'block';
             paramsContainer.querySelectorAll('input').forEach(input => input.required = true);
        }
    }

    function addProductButton() {
        const container = document.getElementById('product-buttons-container');
        const buttonCount = container.querySelectorAll('.product-button-group').length;
        if (buttonCount >= 3) {
            alert('You can only add up to 3 buttons.');
            return;
        }
        const newGroup = document.createElement('div');
        newGroup.className = 'form-group product-button-group';
        newGroup.innerHTML = `
            <label>Button ${buttonCount + 1}:</label>
            <button type="button" class="add-remove-btn remove-btn" onclick="removeProductButton(this)">Remove</button>
            <div class="form-group">
                <label>Button Type:</label>
                <select class="form-control product-button-type" onchange="updateProductButtonFields(this)">
                    <option value="reply">Quick Reply</option>
                    <option value="url">URL</option>
                </select>
            </div>
            <div class="button-params-container reply-params">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control reply-display-text" name="product_button_${buttonCount + 1}_text" placeholder="e.g., 'Buy Now'" required>
                </div>
                <div class="form-group">
                    <label>Button ID:</label>
                    <input type="text" class="form-control reply-id" name="product_button_${buttonCount + 1}_id" placeholder="e.g., 'buy_123'" required>
                </div>
            </div>
            <div class="button-params-container url-params" style="display:none;">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control url-display-text" name="product_button_${buttonCount + 1}_text_url" placeholder="e.g., 'Visit Product Page'" required>
                </div>
                <div class="form-group">
                    <label>URL:</label>
                    <input type="url" class="form-control url-input" name="product_button_${buttonCount + 1}_url_link" placeholder="https://example.com/product" required>
                </div>
            </div>
        `;
        container.appendChild(newGroup);
    }

    function removeProductButton(btn) {
        btn.closest('.product-button-group').remove();
    }

    function updateProductButtonFields(select) {
        const container = select.closest('.product-button-group');
        const type = select.value;
        container.querySelectorAll('.button-params-container').forEach(el => {
            el.style.display = 'none';
            el.querySelectorAll('input').forEach(input => input.required = false);
        });
        const paramsContainer = container.querySelector(`.${type}-params`);
        if (paramsContainer) {
            paramsContainer.style.display = 'block';
            paramsContainer.querySelectorAll('input').forEach(input => input.required = true);
        }
    }

    function updatePollOptionLabels() {
        const options = document.querySelectorAll('.poll-option-group');
        options.forEach((opt, index) => {
            opt.querySelector('.poll-option').placeholder = `Option ${index + 1}`;
            const removeBtn = opt.querySelector('.remove-option');
            removeBtn.style.display = options.length > 2 ? 'block' : 'none';
        });
    }

    function addNativeFlowButton() {
        const container = document.getElementById('native-flow-buttons-container');
        const newGroup = document.createElement('div');
        newGroup.className = 'form-group native-flow-button-group';
        newGroup.innerHTML = `
            <label>Button:</label>
            <button type="button" class="add-remove-btn remove-btn" onclick="this.closest('.native-flow-button-group').remove();">Remove</button>
            <div class="form-group">
                <label>Button Type:</label>
                <select class="form-control native-flow-button-type" onchange="updateNativeFlowButtonFields(this)">
                    <option value="cta_reply">Quick Reply</option>
                    <option value="cta_url">URL</option>
                    <option value="cta_call">Call</option>
                </select>
            </div>
            <div class="button-params-container cta_reply-params">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control reply-display-text" name="native_reply_text_${Date.now()}" placeholder="e.g., 'Get Info'" required>
                </div>
                <div class="form-group">
                    <label>Button ID:</label>
                    <input type="text" class="form-control reply-id" name="native_reply_id_${Date.now()}" placeholder="e.g., 'info_123'" required>
                </div>
            </div>
            <div class="button-params-container cta_url-params" style="display:none;">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control url-display-text" name="native_url_text_${Date.now()}" placeholder="e.g., 'Visit Website'" required>
                </div>
                <div class="form-group">
                    <label>URL:</label>
                    <input type="url" class="form-control url-input" name="native_url_link_${Date.now()}" placeholder="https://example.com" required>
                </div>
            </div>
            <div class="button-params-container cta_call-params" style="display:none;">
                <div class="form-group">
                    <label>Display Text:</label>
                    <input type="text" class="form-control call-display-text" name="native_call_text_${Date.now()}" placeholder="e.g., 'Call Us'" required>
                </div>
            </div>
        `;
        container.appendChild(newGroup);
    }
    
    function updateNativeFlowButtonFields(select) {
        const container = select.closest('.native-flow-button-group');
        const type = select.value;
        container.querySelectorAll('.button-params-container').forEach(el => {
            el.style.display = 'none';
            el.querySelectorAll('input').forEach(input => input.required = false);
        });
        const paramsContainer = container.querySelector(`.${type}-params`);
        if (paramsContainer) {
            paramsContainer.style.display = 'block';
            paramsContainer.querySelectorAll('input').forEach(input => input.required = true);
        }
    }

    async function fetchTemplates(type) {
        try {
            // Populate the specific form dropdown
            if (type !== 'all') {
                const selectElement = document.getElementById(`${type}-template-select`);
                selectElement.innerHTML = '<option value="">-- Load Template --</option>';
            }
            
            // Fetch all templates to populate the bulk send dropdown
            const bulkSelect = document.getElementById('bulk-template-select');
            const response = await fetch(`/templates`); // Fetch all
            const result = await response.json();
            
            if (result.success && result.data) {
                 bulkSelect.innerHTML = '<option value="">-- Select Template --</option>';
                 for (const name in result.data) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${result.data[name].type})`;
                    bulkSelect.appendChild(option);
                    
                    const templateType = result.data[name].type;
                    const formSelect = document.getElementById(`${templateType}-template-select`);
                    if (formSelect) {
                         const formOption = document.createElement('option');
                         formOption.value = name;
                         formOption.textContent = name;
                         formSelect.appendChild(formOption);
                    }
                 }
            }
        } catch (error) {
            console.error(`Failed to fetch templates:`, error);
        }
    }

    async function handleSaveTemplate(formId) {
        const form = document.getElementById(formId);
        const type = formId.replace('-message-form', '');
        
        const templateName = prompt("Enter a name for this template:");
        if (!templateName) return;

        try {
            let data;
            if (formId === 'text-message-form') {
                data = {
                    text: document.getElementById('text-content').value
                };
            } else if (formId === 'interactive-message-form') {
                data = {
                    body: document.getElementById('interactive-body').value,
                    imageUrl: document.getElementById('interactive-image-url').value,
                    buttons: getInteractiveButtons()
                };
            } else if (formId === 'product-message-form') {
                const buttons = getProductButtons();
                data = {
                    businessOwnerJid: document.getElementById('product-business-jid').value,
                    message: {
                        title: document.getElementById('product-msg-title').value,
                        caption: document.getElementById('product-msg-caption').value,
                        footer: document.getElementById('product-msg-footer').value,
                    },
                    product: {
                        imageUrl: document.getElementById('product-image-url').value,
                        title: document.getElementById('product-title').value,
                        description: document.getElementById('product-description').value,
                        price: parseFloat(document.getElementById('product-price').value),
                        currencyCode: document.getElementById('product-currency').value,
                        retailerId: document.getElementById('product-retailer-id').value,
                        url: document.getElementById('product-url').value
                    },
                    buttons: buttons
                };
            } else if (formId === 'poll-message-form') {
                 const options = Array.from(document.querySelectorAll('.poll-option')).map(input => input.value).filter(val => val.trim() !== '');
                 data = {
                     question: document.getElementById('poll-question').value,
                     options: options,
                     selectableOptionsCount: parseInt(document.getElementById('poll-selectable-count').value) || 1
                 };
             } else if (formId === 'native-flow-form') {
                const buttons = [];
                document.querySelectorAll('#native-flow-buttons-container .native-flow-button-group').forEach(group => {
                    const buttonType = group.querySelector('.native-flow-button-type').value;
                    let params = {};
                    if (buttonType === 'cta_url') {
                        params.display_text = group.querySelector('.url-display-text').value;
                        params.url = group.querySelector('.url-input').value;
                        params.merchant_url = group.querySelector('.url-input').value;
                    } else if (buttonType === 'cta_reply') {
                        params.display_text = group.querySelector('.reply-display-text').value;
                        params.id = group.querySelector('.reply-id').value;
                    } else if (buttonType === 'cta_call') {
                        params.display_text = group.querySelector('.call-display-text').value;
                    }
                    buttons.push({ name: buttonType, params });
                });
                data = {
                    title: document.getElementById('native-flow-title').value,
                    subtitle: document.getElementById('native-flow-subtitle').value,
                    body: document.getElementById('native-flow-body').value,
                    footer: document.getElementById('native-flow-footer').value,
                    buttons: buttons
                };
             }

            const response = await fetch('/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: templateName, type, data })
            });
            const result = await response.json();
            
            alert(result.success ? result.message : `Error saving template: ${result.error}`);
            if (result.success) {
                fetchTemplates('all');
            }
        } catch (error) {
            alert(`Request failed: ${error.message}`);
        }
    }

    async function handleLoadTemplate(event) {
        const selectElement = event.target;
        const formId = selectElement.id.replace('-template-select', '-message-form');
        const form = document.getElementById(formId);
        const templateName = selectElement.value;

        if (!templateName) {
            form.reset();
            return;
        }

        try {
            const type = formId.replace('-message-form', '');
            const response = await fetch(`/templates/${type}`);
            const result = await response.json();

            if (result.success && result.data && result.data[templateName]) {
                const templateData = result.data[templateName];
                
                if (type === 'text') {
                    document.getElementById('text-content').value = templateData.text;
                } else if (type === 'interactive') {
                    document.getElementById('interactive-body').value = templateData.body;
                    document.getElementById('interactive-image-url').value = templateData.imageUrl || '';
                    
                    const buttonsContainer = document.getElementById('interactive-buttons-container');
                    buttonsContainer.innerHTML = '';
                    templateData.buttons.forEach((btn) => {
                         addInteractiveButton();
                         const newGroup = buttonsContainer.lastElementChild;
                         const typeSelect = newGroup.querySelector('.interactive-button-type');
                         typeSelect.value = btn.type;
                         updateInteractiveButtonFields(typeSelect);
                         if (btn.type === 'reply') {
                             newGroup.querySelector('.reply-display-text').value = btn.displayText;
                             newGroup.querySelector('.reply-id').value = btn.id;
                         } else if (btn.type === 'url') {
                             newGroup.querySelector('.url-display-text').value = btn.displayText;
                             newGroup.querySelector('.url-input').value = btn.url;
                         }
                     });
                } else if (type === 'product') {
                     document.getElementById('product-business-jid').value = templateData.businessOwnerJid;
                     document.getElementById('product-msg-title').value = templateData.message.title;
                     document.getElementById('product-msg-caption').value = templateData.message.caption;
                     document.getElementById('product-msg-footer').value = templateData.message.footer;
                     document.getElementById('product-image-url').value = templateData.product.imageUrl;
                     document.getElementById('product-title').value = templateData.product.title;
                     document.getElementById('product-description').value = templateData.product.description;
                     document.getElementById('product-price').value = templateData.product.price;
                     document.getElementById('product-currency').value = templateData.product.currencyCode;
                     document.getElementById('product-retailer-id').value = templateData.product.retailerId;
                     document.getElementById('product-url').value = templateData.product.url;
                     
                     const buttonsContainer = document.getElementById('product-buttons-container');
                     buttonsContainer.innerHTML = '';
                     templateData.buttons.forEach((btn) => {
                         addProductButton();
                         const newGroup = buttonsContainer.lastElementChild;
                         const typeSelect = newGroup.querySelector('.product-button-type');
                         typeSelect.value = btn.type;
                         updateProductButtonFields(typeSelect);
                         if (btn.type === 'reply') {
                             newGroup.querySelector('.reply-display-text').value = btn.displayText;
                             newGroup.querySelector('.reply-id').value = btn.id;
                         } else if (btn.type === 'url') {
                             newGroup.querySelector('.url-display-text').value = btn.displayText;
                             newGroup.querySelector('.url-input').value = btn.url;
                         }
                     });
                } else if (type === 'poll') {
                     document.getElementById('poll-question').value = templateData.question;
                     document.getElementById('poll-selectable-count').value = templateData.selectableOptionsCount;
                     
                     const optionsContainer = document.getElementById('poll-options-container');
                     optionsContainer.innerHTML = '<p>Options (Add at least 2)</p>';
                     templateData.options.forEach((optionText, index) => {
                          const newGroup = document.createElement('div');
                          newGroup.className = 'poll-option-group';
                          newGroup.innerHTML = `
                             <input type="text" class="form-control poll-option" placeholder="Option ${index + 1}" value="${optionText}" required>
                             <button type="button" class="add-remove-btn remove-option">Remove</button>
                          `;
                          optionsContainer.appendChild(newGroup);
                     });
                     updatePollOptionLabels();
                } else if (type === 'nativeflow') {
                    document.getElementById('native-flow-title').value = templateData.title || '';
                    document.getElementById('native-flow-subtitle').value = templateData.subtitle || '';
                    document.getElementById('native-flow-body').value = templateData.body || '';
                    document.getElementById('native-flow-footer').value = templateData.footer || '';
                    
                    const buttonsContainer = document.getElementById('native-flow-buttons-container');
                    buttonsContainer.innerHTML = '';
                    templateData.buttons.forEach(btn => {
                        addNativeFlowButton();
                        const newGroup = buttonsContainer.lastElementChild;
                        const typeSelect = newGroup.querySelector('.native-flow-button-type');
                        typeSelect.value = btn.name;
                        
                        updateNativeFlowButtonFields(typeSelect);

                        if (btn.name === 'cta_url') {
                            newGroup.querySelector('.url-display-text').value = btn.params.display_text || '';
                            newGroup.querySelector('.url-input').value = btn.params.url || '';
                        } else if (btn.name === 'cta_reply') {
                            newGroup.querySelector('.reply-display-text').value = btn.params.display_text || '';
                            newGroup.querySelector('.reply-id').value = btn.params.id || '';
                        } else if (btn.name === 'cta_call') {
                            newGroup.querySelector('.call-display-text').value = btn.params.display_text || '';
                        }
                    });
                }
            } else {
                console.error('Template not found.');
            }
        } catch (error) {
            console.error('Failed to load template:', error);
        }
    }

    document.getElementById('create-session-btn').addEventListener('click', handleCreateSession);
    document.getElementById('session-select').addEventListener('change', (e) => {
        currentSessionName = e.target.value;
        pollBulkStatus(currentSessionName);
        fetchTemplates('all');
    });
    
    document.getElementById('text-message-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'text-message-status'));
    document.getElementById('interactive-message-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'interactive-message-status'));
    document.getElementById('product-message-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'product-message-status'));
    document.getElementById('poll-message-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'poll-message-status'));
    document.getElementById('native-flow-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'native-flow-status'));
    document.getElementById('bulk-message-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'bulk-message-status'));
    document.getElementById('bulk-add-to-group-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'bulk-add-to-group-status'));
    document.getElementById('get-groups-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'get-groups-status'));
    document.getElementById('get-single-group-form').addEventListener('submit', (e) => handleFormSubmit(e, '', 'get-single-group-status'));

    document.getElementById('save-text-template-btn').addEventListener('click', () => handleSaveTemplate('text-message-form'));
    document.getElementById('save-interactive-template-btn').addEventListener('click', () => handleSaveTemplate('interactive-message-form'));
    document.getElementById('save-product-template-btn').addEventListener('click', () => handleSaveTemplate('product-message-form'));
    document.getElementById('save-poll-template-btn').addEventListener('click', () => handleSaveTemplate('poll-message-form'));
    
    document.getElementById('cancel-bulk-task-btn').addEventListener('click', handleCancelBulkTask);

    document.getElementById('add-interactive-button').addEventListener('click', addInteractiveButton);
    document.getElementById('add-product-button').addEventListener('click', addProductButton);
    document.getElementById('add-native-flow-button').addEventListener('click', addNativeFlowButton);

    document.getElementById('text-template-select').addEventListener('change', handleLoadTemplate);
    document.getElementById('interactive-template-select').addEventListener('change', handleLoadTemplate);
    document.getElementById('product-template-select').addEventListener('change', handleLoadTemplate);
    document.getElementById('poll-template-select').addEventListener('change', handleLoadTemplate);

    document.getElementById('group-search').addEventListener('input', (event) => {
        const searchTerm = event.target.value.toLowerCase();
        const filteredGroups = allGroups.filter(group => (group.name || '').toLowerCase().includes(searchTerm));
        displayGroups(filteredGroups);
    });

    addInteractiveButton();
    addProductButton();
    addNativeFlowButton();

    window.onload = () => {
        fetchSessions();
        fetchTemplates('all');
        pollBulkStatus(currentSessionName);
        setInterval(fetchSessions, 10000);
    };
</script>

</body>
</html>